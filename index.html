<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#111111">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Gestionnaire de combat D&D 3.5</title>
<style>
body {
  margin:0;
  font-family: system-ui, sans-serif;
  background:#1e1e1e;
  color:#eee;
  position: fixed; /* emp√™che tout d√©calage visuel de la fen√™tre */
  width: 100%;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  overscroll-behavior: none; /* emp√™che le rebond du scroll */
  touch-action: manipulation; /* d√©sactive le zoom par double tap et les gestes √† deux doigts */
}
h2 { text-align:center; margin:0.5em 0; font-size:1.2rem; }
.tab { display:none; height:100%; flex-direction:column; }

nav {
  position:fixed; bottom:0; left:0; width:100%; display:flex;
  background:#222; border-top:1px solid #444; height:64px; z-index:100;
}
nav button {
  flex:1; border:none; background:#222; color:#ccc;
  font-size:1rem; cursor:pointer;
}
nav button.active { background:#444; color:#fff; }

.flex { display:flex; flex-wrap:wrap; gap:6px; align-items:center; margin-bottom:10px; }
input, select { flex:1; min-width:20px; font-size:1rem; padding:6px; border-radius:6px; border:1px solid #555; background:#2b2b2b; color:#fff; }
button { background:#444; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:1rem; }
button:hover { background:#666; }
.list { overflow:auto; }

#charSelect {
    min-width: 180px;
}

.participant {
  background:#2b2b2b;
  border:1px solid #444;
  border-radius:8px;
  padding:10px;
  margin-bottom:8px;
  position:relative;
  transition: transform 0.6s ease, opacity 0.2s ease;
}

.participant.moving {
  opacity: 0.6;
}

.participant.active {
  border: 2px solid #00bcd4;
  background: #2f2f3f;
  box-shadow: 0 0 10px #00bcd4;
}

.participant .pv-control {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-top: 6px;
}

.participant .pv-display {
  flex: 0 0 auto;
  min-width: 50px;
  text-align: center;
  margin: 0 8px;
  font-weight: bold;
  text-shadow: 1px 1px 3px #000;
}

.participant button.small {
  flex: 0 0 auto;
  padding:2px 6px;
  font-size:0.8rem;
  border-radius:4px;
}

.participant button.remove {
  position:absolute;
  right:10px;
  top:10px;
  background:#b33;
  color:#fff;
  padding:4px 8px;
  border:none;
  border-radius:6px;
  font-size:0.9rem;
  cursor:pointer;
}
.participant button.remove:hover { background:#d55; }

button.remove-small {
  background: #b33;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 2px 6px;
  font-size: 0.8rem;
  cursor: pointer;
}
button.remove-small:hover {
  background: #d55;
}

#rollInit {
  padding: 1px 2px;
  font-size: 1.8rem;
  border-radius: 6px;
  background: none;
  color: #fff;
  cursor: pointer;
}
#rollInit:hover {
  background: none;
}

/* D√© 3D r√©aliste */
.d20 {
  width: 28px;
  height: 28px;
  margin: 2px;
  bottom: 1px;
  right: 1px;
  perspective: 500px;
  cursor: pointer;
  position: relative;
}

.d20-inner {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
}

.d20 .face {
  position: absolute;
  width: 100%;
  height: 100%;
  border: 1.5px solid #05b;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.85rem;
  color: #fff;
  background: radial-gradient(circle at 30% 30%, #111, #000);
  box-shadow: inset 0 0 8px #0ff3, 0 0 5px #0ff2;
  backface-visibility: hidden; /* ‚úÖ emp√™che les doublons en rotation */
}

/* 6 faces orient√©es en 3D */
.face.front  { transform: translateZ(15px); }
.face.back   { transform: rotateY(180deg) translateZ(15px); }
.face.right  { transform: rotateY(90deg) translateZ(15px); }
.face.left   { transform: rotateY(-90deg) translateZ(15px); }
.face.top    { transform: rotateX(90deg) translateZ(15px); }
.face.bottom { transform: rotateX(-90deg) translateZ(15px); }

.d20.rolling .d20-inner {
  animation: spinAndRoll 1.5s ease-in-out infinite;
}

/* Rotation combin√©e pour un effet plus al√©atoire */
@keyframes spinAndRoll {
  0%   { transform: rotateX(0deg) rotateY(0deg); }
  25%  { transform: rotateX(180deg) rotateY(90deg); }
  50%  { transform: rotateX(360deg) rotateY(180deg); }
  75%  { transform: rotateX(540deg) rotateY(270deg); }
  100% { transform: rotateX(720deg) rotateY(360deg); }
}

#initInput {
  font-size: 1rem;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #2b2b2b;
  color: #fff;
  text-align: center;
}

.subtabs { display:flex; gap:6px; margin-bottom:8px; }
.subtab-btn {
  flex:1;
  padding:6px; background:#333; color:#ccc; border:none; border-radius:6px; cursor:pointer;
}
.subtab-btn.active { background:#555; color:#fff; }

.subtab-content { display:flex; flex-direction:column; gap:6px; }

#roundDisplay { font-weight:bold; }

#secondDisplay { font-weight:bold; }

/* Modale confirmation */
#confirmModal {
  position:fixed; inset:0; background:rgba(0,0,0,0.6);
  display:none; align-items:center; justify-content:center; z-index:200;
}
#confirmBox {
  background:#2b2b2b; padding:20px; border-radius:10px;
  text-align:center; width:80%; max-width:300px; box-shadow:0 0 10px #000;
}
#confirmBox button { margin:10px 6px 0 6px; }

#nextTurn {
  background-color: #3a3a3a;   /* couleur de fond active */
  color: white;
  border-radius: 6px;
  transition: all 0.2s ease-in-out;
}

/* üü¢ Apparence quand le bouton est actif */
#nextTurn:not(:disabled) {
  background-color: #2e8b57;   /* vert fonc√© ou ta couleur de th√®me */
  border-color: #1f6b43;
  box-shadow: 0 0 6px #1f6b43;
}

/* üî¥ Apparence quand il est d√©sactiv√© */
#nextTurn:disabled {
  background-color: #222;
  color: #777;
  border-color: #444;
  opacity: 0.6;
  box-shadow: none;
  pointer-events: none;
}

/* Combat scrollable */
#combatContent { display:flex; flex-direction:column; height:calc(100% - 105px); }
.combat-top { flex-shrink:0; padding:10px; background:#2a2a2a; border-bottom:1px solid #444; display:flex; flex-direction:column; gap:8px; }
.combat-list { flex:1; overflow-y:auto; padding:8px;}
.combat-bottom { flex-shrink:0; position: sticky; bottom: calc(64px + env(safe-area-inset-bottom)); padding:8px; background:#2a2a2a; border-top:1px solid #444; display:flex; justify-content:space-between; gap:2px; }

/* === Zones de liste d√©filables === */
#herosList, 
#alliesList, 
#ennemisList {
  overflow-y: auto;
  flex: 1;
  max-height: calc(100vh - 200px); /* Ajuste selon ton ent√™te et ton pied de page */
  padding: 6px 0;
}
#buffList {
  overflow-y: auto;
  flex: 1;
  max-height: calc(100vh - 160px); /* Ajuste selon ton ent√™te et ton pied de page */
  padding: 6px 0;
}


/* Target list dropdown */
#targetList {
  display:none;
  position:absolute;
  background:#2b2b2b;
  border:1px solid #444;
  max-height:150px;
  width: 140px;
  overflow-y:auto;
  z-index:10;
  padding:0;
}
#targetList label {
  display:block;
  position:relative;
  padding-left:24px;
  margin:2px 0;
  cursor:pointer;
  user-select:none;
}
#targetList input[type=checkbox] {
  position:absolute;
  left:0;
  top:50%;
  transform:translateY(-50%);
  margin:0;
}

/* === Styles pour la gestion des PV, SP, et Init en modal === */
#hpModal .pv-control,
#initModal .init-control{
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin: 12px 0;
}

#hpModal .pv-display,
#initModal .init-display {
  flex: 0 0 auto;
  width: 170px;
  max-width: 50%;
  text-align: center;
  padding: 6px;
  background: #333;
  border-radius: 6px;
  border: 1px solid #555;
  color: #fff;
  font-weight: bold;
}

#hpModal .small,
#initModal .small {
  padding: 4px 10px;
  font-size: 0.9rem;
}

/* Modale confirmation */
#confirmModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 400; /* <-- plus haut que hpModal */
}

.modal-field {
  display: flex;
  flex-direction: column;
  width: 100%;
}

.modal-field label {
  margin-bottom: 4px;
  font-size: 0.9rem;
  color: #ccc;
  font-weight: bold;
}

.modal-field input {
  width: 95%;
  padding: 6px;
  margin-bottom: 6px;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #555;
  background: #1e1e1e;
  color: #fff;
}

/* Ligne PV + Initiative dans le modal */
.pv-init-row {
  display: flex;
  gap: 18px;          /* Moins grand espace pour √©viter de d√©passer */
  width: 100%;
  box-sizing: border-box;
}

/* Chaque champ prend exactement la moiti√© de la ligne */
.pv-init-row label {
  flex: 1;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}

/* Emp√™che les inputs de d√©border */
.pv-init-row input {
  width: 100%;
  text-align: center;
  box-sizing: border-box;
}

.modal {
  position: fixed; inset: 0; display: none;
  align-items: center; justify-content: center;
  background: rgba(0,0,0,0.6); z-index: 300;
}

.modal-content {
  position: relative; /* ‚úÖ permet au bouton de se positionner relativement au modale */
  background: #222;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  text-align: center;
}

.modal-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 16px;
  gap: 12px;
}

.modal-buttons button {
  flex: 1;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: bold;
}

.modal-buttons .cancel {
  background: #444;
  color: #bbb;
  border: 1px solid #666;
}

.modal-buttons .validate {
  background: #4caf50;
  color: #fff;
  border: 1px solid #3a8b3d;
}

.reset-btn {
  position: absolute;
  align-items: right;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  font-size: 1.2rem;
  color: #bbb;
  cursor: pointer;
  padding: 0;
}
.reset-btn:hover {
  background: #fff;
}

.hp-bar-container {
  position: relative;
  width: 100%;
  height: 20px;
  background: #d55;
  border-radius: 6px;
  overflow: hidden;
  margin: 6px 0;
}

.hp-bar {
  height: 100%;
  background: linear-gradient(90deg, #2ecc71, #27ae60);
  transition: width 0.2s ease-out;
}

.sp-bar {
  position: absolute;
  top: 0;
  height: 100%;
  background: #6a5acd; /* mauve */
  opacity: 0.8;
  transition: width 0.2s ease-out, left 0.2s ease-out;
}

.hp-text {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  pointer-events: none; /* clic d√©sactiv√© pour le texte, activ√© sur le container */
  color: #fff;
  text-shadow: 1px 1px 3px #000;
}

.clickable {
  pointer-events: auto; /* r√©active le clic */
  cursor: pointer;
}

#settingsIcon {
  position: fixed;
  top: 5px;
  right: 10px;
  font-size: 24px;
  cursor: pointer;
  z-index: 500;
  color: #fff;
  opacity: 0.7;
  transition: opacity 0.2s;
}
#settingsIcon:hover {
  opacity: 1;
}

@media(max-width:600px){
h2{font-size:1.1rem;} button{font-size:0.9rem;} input,select{font-size:0.9rem;}
}
</style>
</head>
<body>

<!-- Onglet Combat -->
<div id="combat" class="tab" style="display:flex;">
  <h2>‚öîÔ∏è Gestionnaire de combat</h2>
  <div id="combatContent">
    <div class="combat-top">
      <div class="flex">
        <select id="charSelect"></select>
        <input id="initInput" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Init" onfocus="this.select()" onclick="this.select()">
        <button id="addToCombat">Rejoindre !</button>
        <div id="d20Container" style="position:relative; display:flex; align-items:center;">
          <div id="rollD20Btn" class="d20" title="Lancer un D20">
            <div class="d20-inner">
              <div class="face front">?</div>
              <div class="face back"></div>
              <div class="face left"></div>
              <div class="face right"></div>
              <div class="face top"></div>
              <div class="face bottom"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Buffs globaux et round -->
      <div class="flex" style="align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:6px;width:100%">
          <div id="buffSelector" style="position:relative;width:90%;">
            <input type="text" id="buffSearch" placeholder="Rechercher un buff..." style="width:92%;padding:6px;border-radius:6px;border:none;background:#222;color:#fff;">
            <div id="buffDropdown" style="position:absolute;top:100%;left:0;width:100%;background:#1a1a1a;border:1px solid #333;border-radius:6px;max-height:180px;overflow-y:auto;display:none;z-index:10;"></div>
          </div>
          <div style="position:relative;">
            <button id="chooseTargets">Cibles</button>
            <div id="targetList"></div>
          </div>
          <button id="applyBuffGlobal">Lancer</button>
        </div>
      </div>
      <div class="flex" style="margin:0;">
        <div>Round : <span id="roundDisplay">0</span> (<span id="secondDisplay">6</span><span id="secondLabel"> secondes</span>)</div>
      </div>
    </div>
    <div class="combat-list" id="combatList"></div>
    <div class="combat-bottom">
      <button onclick="startCombat()">D√©but du combat</button>
      <button id="nextTurn" disabled>Tour suivant</button>
      <button onclick="resetCombat()" style="background:#b33;">üßπ R√©initialiser</button>
    </div>
  </div>
</div>

<!-- Onglet Personnages -->
<div id="characters" class="tab">
  <h2>üßô Personnages</h2>
  <div class="subtabs">
    <button class="subtab-btn active" data-subtab="heros">üó°Ô∏è H√©ros</button>
    <button class="subtab-btn" data-subtab="allies">ü§ù Alli√©s</button>
    <button class="subtab-btn" data-subtab="ennemis">üíÄ Ennemis</button>
  </div>
  
  <!-- Contenu de chaque sous-onglet -->
  <div id="heros" class="subtab-content">
    <div class="flex">
      <input id="herosName" placeholder="Nom">
      <input id="herosClasse" placeholder="Classe">
      <input id="herosRace" placeholder="Race">
      <button id="addHero">Ajouter</button>
    </div>
    <div class="list" id="herosList"></div>
  </div>
  
  <div id="allies" class="subtab-content" style="display:none;">
    <div class="flex">
      <input id="alliesName" placeholder="Nom">
      <input id="alliesClasse" placeholder="Classe">
      <input id="alliesRace" placeholder="Race">
      <button id="addAlly">Ajouter</button>
    </div>
    <div class="list" id="alliesList"></div>
  </div>
  
  <div id="ennemis" class="subtab-content" style="display:none;">
    <div class="flex">
      <input id="ennemisName" placeholder="Nom">
      <input id="ennemisClasse" placeholder="Classe">
      <input id="ennemisRace" placeholder="Race">
      <button id="addEnemy">Ajouter</button>
    </div>
    <div class="list" id="ennemisList"></div>
  </div>
</div>

<!-- Onglet Buffs -->
<div id="buffs" class="tab">
  <h2>‚ú® Buffs</h2>
  <div class="flex">
    <input id="buffName" placeholder="Nom">
    <input id="buffDuration" inputmode="numeric" pattern="[0-9]*" placeholder="Dur√©e" onfocus="this.select()" onclick="this.select()">
    <input id="buffValue" placeholder="Description">
    <button id="addBuff">Ajouter</button>
  </div>
  <div class="list" id="buffList"></div>
</div>

<!-- Barre onglets -->
<nav>
  <button data-tab="characters">üßô Personnages</button>
  <button data-tab="combat" class="active">‚öîÔ∏è Combat</button>
  <button data-tab="buffs">‚ú® Buffs</button>
</nav>

<!-- Modale confirmation -->
<div id="confirmModal">
  <div id="confirmBox">
    <p id="confirmText"></p>
    <button id="confirmNo">Non</button>
    <button id="confirmYes" style="background:#b33;">Oui</button>
  </div>
</div>

<!-- Modal Edition Personnage -->
<div id="editCharModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:200;">
  <div style="background:#2b2b2b; padding:20px; border-radius:10px; width:90%; max-width:300px; box-shadow:0 0 10px #000; color:#fff;">
    <h3 id="editCharTitle" style="text-align:center; margin-bottom:15px;">Modifier le personnage</h3>
    <div style="flex-direction:column; gap:12px;">
      <div class="modal-field">
        <label>Classe : </label>
        <input id="editCharClasse" placeholder="Classe">
      </div>
      <div class="modal-field">
        <label>Race : </label>
        <input id="editCharRace" placeholder="Race">
      </div>
      <div class="pv-init-row">
        <div class="modal-field" id="modalHpField">
          <label>PV : </label>
          <input id="editCharHp" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="PV max" onfocus="this.select()" onclick="this.select()">
        </div>
        <div class="modal-field">
          <label>Initiative : </label>
          <input id="editCharInit" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Initiative de base" onfocus="this.select()" onclick="this.select()">
        </div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:15px;">
      <button onclick="closeCharEdit()" style="background:#b33;">Annuler</button>
      <button onclick="validateCharEdit()" style="background:#2e8b57;">Valider</button>
    </div>
  </div>
</div>

<!-- Modale d‚Äô√©dition de Buff -->
<div id="buffEditModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:200;">
  <div style="background:#2b2b2b; padding:20px; border-radius:10px; width:90%; max-width:300px; box-shadow:0 0 10px #000; color:#fff;">
    <h3 id="buffEditTitle" style="text-align:center; margin-bottom:15px;">Modifier le buff</h3>
    <div style="flex-direction:column; gap:12px;">
      <div class="modal-field">
        <label>Nom</label>
        <input id="editBuffName" type="text">
      </div>
      <div class="modal-field">
        <label>Dur√©e (tours)</label>
        <input id="editBuffDuration" type="number">
      </div>
      <div class="modal-field">
        <label>Description</label>
        <input id="editBuffValue" type="text">
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:15px;">
      <button onclick="closeBuffEditModal()" style="background:#b33;">Annuler</button>
      <button onclick="saveBuffEdit()" style="background:#2e8b57;">Valider</button>
    </div>
  </div>
</div>

<!-- Ic√¥ne d'options -->
<div id="settingsIcon" title="Options">‚öôÔ∏è</div>
<!-- Menu d‚Äôoptions -->
<div id="settingsModal" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>Options</h3>
    <button onclick="clearLocalStorage()" style="background:#b33;">üóëÔ∏è Effacer les donn√©es</button>
    <br><br>
    <button onclick="closeSettingsModal()">Fermer</button>
  </div>
</div>

<script>
// ===== Donn√©es =====
let data = JSON.parse(localStorage.getItem("dndData")||"{}");
if(!data.characters) data.characters=[];
if(!data.buffs) data.buffs=[];
if(!data.combat) data.combat={participants:[],round:0,currentIndex:-1};
function saveData(){localStorage.setItem("dndData",JSON.stringify(data));}

// ===== Onglets =====
const tabs=document.querySelectorAll("nav button");
const sections=document.querySelectorAll(".tab");
tabs.forEach(btn=>{
  btn.addEventListener("click",()=>{
    tabs.forEach(b=>b.classList.remove("active"));
    sections.forEach(s=>s.style.display="none");
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).style.display="flex";
    renderAll();
  });
});

// ===== Personnages =====
const subtabBtns = document.querySelectorAll(".subtab-btn");
const subtabContents = document.querySelectorAll(".subtab-content");
subtabBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    subtabBtns.forEach(b=>b.classList.remove("active"));
    subtabContents.forEach(c=>c.style.display="none");
    btn.classList.add("active");
    document.getElementById(btn.dataset.subtab).style.display="flex";
  });
});

function addHero() {
  const name = document.getElementById("herosName").value;
  const classe = document.getElementById("herosClasse").value;
  const race = document.getElementById("herosRace").value;
  const hp = 1; // valeur de base
  const init = null; // valeur de base
  if(!name) return;
  data.characters.push({id:Date.now(),name,classe,race,type:"h√©ros",maxHp:hp,baseInit:init});
  saveData(); renderHeros(); 
  document.getElementById("herosName").value=""; 
  document.getElementById("herosClasse").value="";
  document.getElementById("herosRace").value="";
}

function addAlly() {
  const name = document.getElementById("alliesName").value;
  const classe = document.getElementById("alliesClasse").value;
  const race = document.getElementById("alliesRace").value;
  const hp = 1; // valeur de base
  const init = null; // valeur de base
  if(!name) return;
  data.characters.push({id:Date.now(),name,classe,race,type:"alli√©",maxHp:hp,baseInit:init});
  saveData(); renderAllies(); 
  document.getElementById("alliesName").value=""; 
  document.getElementById("alliesClasse").value="";
  document.getElementById("alliesRace").value="";
}

function addEnemy() {
  const name = document.getElementById("ennemisName").value;
  const classe = document.getElementById("ennemisClasse").value;
  const race = document.getElementById("ennemisRace").value;
  const init = null; // valeur de base
  if(!name) return;
  data.characters.push({id:Date.now(),name,classe,race,type:"ennemi",baseInit:init});
  saveData(); renderEnemies(); 
  document.getElementById("ennemisName").value=""; 
  document.getElementById("ennemisClasse").value="";
  document.getElementById("ennemisRace").value="";
}

document.getElementById("addHero").onclick=addHero;
document.getElementById("addAlly").onclick=addAlly;
document.getElementById("addEnemy").onclick=addEnemy;

function renderHeros(){
  const list = document.getElementById("herosList");
  list.innerHTML="";
  data.characters.filter(c=>c.type==="h√©ros").forEach(c=>{
    const div=document.createElement("div");
    div.className="flex";
    div.innerHTML=`
      <div onclick="editCharacter(${c.id})" style="flex:1;color:#fff;cursor:pointer;">
        <span style="font-weight:bold;">${c.name}</span> (${c.classe} - ${c.race})</div>
      <button class="remove-small" onclick="data.characters=data.characters.filter(x=>x.id!==${c.id});saveData();renderHeros();">‚ùå</button>
    `;
    list.appendChild(div);
  });
}

function renderAllies(){
  const list = document.getElementById("alliesList");
  list.innerHTML="";
  data.characters.filter(c=>c.type==="alli√©").forEach(c=>{
    const div=document.createElement("div");
    div.className="flex";
    div.innerHTML=`
      <div onclick="editCharacter(${c.id})" style="flex:1;color:#fff;cursor:pointer;">
              <span style="font-weight:bold;">${c.name}</span> (${c.classe} - ${c.race})</div>
      <button class="remove-small" onclick="data.characters=data.characters.filter(x=>x.id!==${c.id});saveData();renderAllies();">‚ùå</button>
    `;
    list.appendChild(div);
  });
}

function renderEnemies(){
  const list = document.getElementById("ennemisList");
  list.innerHTML="";
  data.characters.filter(c=>c.type==="ennemi").forEach(c=>{
    const div=document.createElement("div");
    div.className="flex";
    div.innerHTML=`
      <div onclick="editCharacter(${c.id})" style="flex:1;color:#fff;cursor:pointer;">
              <span style="font-weight:bold;">${c.name}</span> (${c.classe} - ${c.race})</div>
      <button class="remove-small" onclick="data.characters=data.characters.filter(x=>x.id!==${c.id});saveData();renderEnemies();">‚ùå</button>
    `;
    list.appendChild(div);
  });
}

let editedCharId = null;

function editCharacter(id) {
  const c = data.characters.find(ch => ch.id === id);
  if (!c) return;
  editedCharId = id;

  document.getElementById("editCharTitle").textContent = c.name;
  document.getElementById("editCharClasse").value = c.classe || "";
  document.getElementById("editCharRace").value = c.race || "";
  document.getElementById("editCharHp").value = c.maxHp || 10;
  document.getElementById("editCharInit").value = c.baseInit || 0;
  
  // Afficher ou masquer PV selon type
    const hpField = document.getElementById("modalHpField");
    if (c.type === "ennemi") {
      hpField.style.display = "none"; // Masque le champ PV
    } else {
      hpField.style.display = "flex"; // Affiche le champ PV
    }

  document.getElementById("editCharModal").style.display = "flex";
}

function validateCharEdit() {
  const c = data.characters.find(ch => ch.id === editedCharId);
  if (!c) return;

  c.classe = document.getElementById("editCharClasse").value;
  c.race = document.getElementById("editCharRace").value;
  c.maxHp = parseInt(document.getElementById("editCharHp").value) || 10;
  c.baseInit = parseInt(document.getElementById("editCharInit").value) || 0;

  saveData();
  renderHeros();
  renderAllies();
  renderEnemies();
  closeCharEdit();
}

function closeCharEdit() {
  editedCharId = null;
  document.getElementById("editCharModal").style.display = "none";
}

// ===== Buffs =====
function renderBuffs(){
  const buffList=document.getElementById("buffList"); buffList.innerHTML="";
  data.buffs.forEach(b=>{
    const div=document.createElement("div");
    div.className="flex";
    div.innerHTML=`
       <div onclick="openBuffEditModal(${b.id})" style="flex:1;color:#fff;cursor:pointer;">
          <span style="font-weight:bold;">${b.name}</span> (${b.defaultDuration || 1}${b.defaultDuration > 1 ? " tours" : " tour"}) ‚Äî ${b.value || "?"}</div>
        <button class="remove-small" onclick="deleteBuff(${b.id})">‚ùå</button>`;
    buffList.appendChild(div);
  });
}

function deleteBuff(id){data.buffs=data.buffs.filter(b=>b.id!==id);saveData();renderBuffs();}
document.getElementById("addBuff").onclick=()=>{
  const name=document.getElementById("buffName").value;
  const value=document.getElementById("buffValue").value;
  const duration=parseInt(document.getElementById("buffDuration").value)||1;
  if(!name) return;
  data.buffs.push({id:Date.now(),name,value,defaultDuration:duration});
  saveData();document.getElementById("buffName").value="";document.getElementById("buffValue").value="";document.getElementById("buffDuration").value="";renderBuffs();
};

let currentBuffEditId = null;

function openBuffEditModal(buffId) {
  const buff = data.buffs.find(b => b.id === buffId);
  if (!buff) return;

  currentBuffEditId = buffId;

  document.getElementById("buffEditTitle").textContent = buff.name;
  document.getElementById("editBuffName").value = buff.name;
  document.getElementById("editBuffValue").value = buff.value || "";
  document.getElementById("editBuffDuration").value = buff.defaultDuration || 1;

  document.getElementById("buffEditModal").style.display = "flex";
}

function closeBuffEditModal() {
  document.getElementById("buffEditModal").style.display = "none";
  currentBuffEditId = null;
}

function saveBuffEdit() {
  if (!currentBuffEditId) return;

  const buff = data.buffs.find(b => b.id === currentBuffEditId);
  if (!buff) return;

  buff.name = document.getElementById("editBuffName").value.trim();
  buff.value = document.getElementById("editBuffValue").value.trim();
  buff.defaultDuration = parseInt(document.getElementById("editBuffDuration").value) || 1;

  saveData();
  renderBuffs();
  closeBuffEditModal();
}

// ===== Combat =====
function renderCharSelect() {
  const sel = document.getElementById("charSelect");

  // üîπ On garde la s√©lection actuelle (si elle existe)
  const previousSelection = sel?.value;

  // IDs des h√©ros d√©j√† en combat
  const activeHeroIds = data.combat.participants
    .filter(p => {
      const c = data.characters.find(ch => ch.id === p.charId);
      return c && c.type === "h√©ros";
    })
    .map(p => p.charId);

  // Filtrer les personnages disponibles
  let availableChars = data.characters.filter(c => !(c.type === "h√©ros" && activeHeroIds.includes(c.id)));

  // Trier par type : H√©ros ‚Üí Alli√©s ‚Üí Ennemis
  const typeOrder = { "h√©ros": 0, "alli√©": 1, "ennemi": 2 };
  availableChars.sort((a, b) => typeOrder[a.type] - typeOrder[b.type]);

  // G√©n√©rer les options
  sel.innerHTML = availableChars
    .map(c => `<option value="${c.id}">${c.name} (${c.type})</option>`)
    .join("");

  // üîπ Si la s√©lection pr√©c√©dente correspond √† un alli√© ou un ennemi, on la restaure
  const prevChar = data.characters.find(ch => ch.id == previousSelection);
  if (prevChar && (prevChar.type === "alli√©" || prevChar.type === "ennemi")) {
    const optionToSelect = sel.querySelector(`option[value="${previousSelection}"]`);
    if (optionToSelect) sel.value = previousSelection;
  }
}

const d20 = document.getElementById("rollD20Btn");
const d20Inner = d20.querySelector(".d20-inner");
const faces = d20.querySelectorAll(".face");
const initInput = document.getElementById("initInput");
const addButton = document.getElementById("addToCombat");

let lastRollResult = null; // on garde le r√©sultat pour l'ajouter au perso

d20.addEventListener("click", async () => {
  if (d20.classList.contains("rolling")) return; // emp√™che de relancer en boucle
  d20.classList.add("rolling");
  d20.disabled = true;
  lastRollResult = null;

  let rollDuration = 1000; // dur√©e totale du roulement
  const start = Date.now();

  // Pendant le roulement : changer les chiffres √† intervalle r√©gulier
  const interval = setInterval(() => {
    faces.forEach(face => {
      face.textContent = Math.floor(Math.random() * 20) + 1;
    });
  }, 100);

  // Attendre la fin du roulement
  await new Promise(r => setTimeout(r, rollDuration));

  // Stopper la rotation
  clearInterval(interval);
  d20.classList.remove("rolling");
  d20.disabled = false;

  // Tirer le vrai r√©sultat final
  const result = Math.floor(Math.random() * 20) + 1;
  faces.forEach(face => face.textContent = result);
  lastRollResult = result;
  setTimeout(() => {
    faces.forEach(face => face.textContent = "?");
  }, 1200);

  // üí• Effet visuel de ‚Äúcritique‚Äù si 20
  if (result === 20) {
    faces.forEach(face => face.style.color = "#ff0");
    d20Inner.style.boxShadow = "0 0 20px #ff0";
    setTimeout(() => {
      faces.forEach(face => face.style.color = "#fff");
      d20Inner.style.boxShadow = "none";
    }, 1200);
  } else if (result === 1) {
    faces.forEach(face => face.style.color = "#f00");
    d20Inner.style.boxShadow = "0 0 20px #f00";
    setTimeout(() => {
      faces.forEach(face => face.style.color = "#fff");
      d20Inner.style.boxShadow = "none";
    }, 1200);
  } else {
    faces.forEach(face => face.style.color = "#fff");
    d20Inner.style.boxShadow = "0 0 20px #fff";
    setTimeout(() => {
      d20Inner.style.boxShadow = "none";
    }, 1200);
  }
  
  addButton.click();
});

document.getElementById("addToCombat").onclick=()=>{
  const charId=parseInt(document.getElementById("charSelect").value);
  const char=data.characters.find(c=>c.id===charId);
  if(!char) return;
  // üßÆ Utilise le dernier jet de d√© si dispo, sinon la valeur saisie manuellement
  const rollValue = lastRollResult ?? (parseInt(document.getElementById("initInput").value) || 0);
  const totalInit = rollValue + (char.baseInit || 0); // ajoute le score de base
  // on remet le r√©sultat √† null pour √©viter les doublons sur un prochain ajout
  lastRollResult = null;
    
  let sameNameCount = data.combat.participants
    .filter(p => p.name.startsWith(char.name))
    .length;
  let participantName = char.name;
  if (char.type === "alli√©" || char.type === "ennemi") {
    participantName += ` ${sameNameCount + 1}`;
  }
  let participant;
  if(char.type==="ennemi"){
    participant = {id:Date.now(), charId:char.id, name:participantName, baseInit:char.baseInit, initiative:totalInit, hp:0, maxHp:null, sp:0, team:char.type, activeBuffs:[]};
  } else {
    participant = {id:Date.now(), charId:char.id, name:participantName, baseInit:char.baseInit, initiative:totalInit, hp:char.maxHp, maxHp:char.maxHp, sp:0, team:char.type, activeBuffs:[]};
  }
  data.combat.participants.push(participant);
  saveData();renderCombat();renderCharSelect();
};

// Scroll automatique uniquement au changement de tour
function scrollToActive() {
  const activeDiv = document.querySelector(".participant.active");
  if(activeDiv) activeDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
}

// PV ajustables
function adjustHp(id, delta){
  const p = data.combat.participants.find(p => p.id === id);
  if(!p) return;

  if(p.team==="h√©ros" || p.team==="alli√©"){
    p.hp = Math.max(-10, p.hp + delta);
  } else {
    p.hp = Math.max(0, p.hp + delta);
  }

  saveData();
  renderCombat();
}
function removeParticipant(id){
  data.combat.participants=data.combat.participants.filter(p=>p.id!==id);
  if(data.combat.currentIndex >= data.combat.participants.length){data.combat.currentIndex=0;}
  saveData(); renderCombat(); renderCharSelect();
}

// D√©placer participant ‚Üë/‚Üì
function moveUp(index) {
  if (index <= 0) return;
  animateMove(index, index - 1);
}

function moveDown(index) {
  const p = data.combat.participants;
  if (index >= p.length - 1) return;
  animateMove(index, index + 1);
}

function animateMove(fromIndex, toIndex) {
  const list = document.getElementById("combatList");
  const items = Array.from(list.children);

  const fromEl = items[fromIndex];
  const toEl = items[toIndex];

  // Position initiale pour l'animation
  const fromRect = fromEl.getBoundingClientRect();
  const toRect = toEl.getBoundingClientRect();

  const dy = toRect.top - fromRect.top;

  // Animation
  fromEl.style.transform = `translateY(${dy}px)`;
  toEl.style.transform = `translateY(${-dy}px)`;
  fromEl.classList.add("moving");
  toEl.classList.add("moving");

  // Apr√®s l‚Äôanimation, √©changer les √©l√©ments dans les donn√©es
  setTimeout(() => {
    data.combat.participants.splice(
      toIndex,
      0,
      data.combat.participants.splice(fromIndex, 1)[0]
    );
    saveData();
    renderCombat();
  }, 600);
}

// Supprimer buff
function removeBuff(participantId, buffIndex){
  const p = data.combat.participants.find(x => x.id === participantId);
  if(!p) return;
  p.activeBuffs.splice(buffIndex,1);
  saveData();
  renderCombat();
}

// Buffs globaux
function renderTargetList(){
  const container = document.getElementById("targetList");
  container.innerHTML="";
  data.combat.participants.forEach(p=>{
    const div = document.createElement("div");
    div.innerHTML = `<label><input type="checkbox" value="${p.id}"> ${p.name}</label>`;
    container.appendChild(div);
  });
}
document.getElementById("chooseTargets").onclick = ()=>{
  const list = document.getElementById("targetList");
  list.style.display = list.style.display==="none" ? "block" : "none";
  renderTargetList();
};

document.getElementById("applyBuffGlobal").onclick = () => {
  const buffName = document.getElementById("buffSearch").value.trim().toLowerCase();
  if (!buffName) return;

  const buff = data.buffs.find(b => b.name.toLowerCase() === buffName);
  applyBuffToSelected(buff);
};

// Tour suivant avec logique buffs par round
document.getElementById("nextTurn").onclick = () => {
  const p = data.combat.participants; 
  if(p.length === 0) return;
  
  data.combat.currentIndex++;

  // --- D√©tection de fin de round ---
  let roundAdvanced = false;
  if(data.combat.currentIndex >= p.length){
    data.combat.currentIndex = 0;
    data.combat.round++;
    roundAdvanced = true; // flag pour le nouveau round
  }

  const currentRound = data.combat.round;
  const current = p[data.combat.currentIndex];

  // --- Gestion des buffs ---
  p.forEach(part => {
    part.activeBuffs.forEach(b => {
      // Buffs li√©s √† un caster
      if(b.casterId && (b.lastDecrementedRound === undefined || b.lastDecrementedRound < currentRound)) {
        if(b.casterId === current.id) {
          b.duration--;
          b.lastDecrementedRound = currentRound;
        }
      }

      // Buffs sans caster (effets globaux)
      if(!b.casterId && roundAdvanced && (b.lastDecrementedRound === undefined || b.lastDecrementedRound < currentRound)){
        b.duration--;
        b.lastDecrementedRound = currentRound;
      }
    });

    // Supprimer les buffs expir√©s
    part.activeBuffs = part.activeBuffs.filter(b => b.duration > 0);
  });

  saveData(); 
  renderCombat(); 
  scrollToActive();
};

// Affichage combat
function renderCombat() {
    const buffDropdown = document.getElementById("buffDropdown");
    const buffSearch = document.getElementById("buffSearch");
  
    // Affichage dynamique de la liste des buffs selon filtre
    function updateBuffList(filter = "") {
      const filtered = data.buffs.filter(b =>
        b.name.toLowerCase().includes(filter.toLowerCase())
      );
  
      buffDropdown.innerHTML = filtered.map(b => `
        <div class="buff-option" 
             data-id="${b.id}"
             style="padding:6px 8px;cursor:pointer;border-bottom:1px solid #333;">
          ${b.name} (${b.defaultDuration})
        </div>
      `).join('');
  
      // Affiche ou cache selon r√©sultat
      buffDropdown.style.display = filtered.length ? "block" : "none";
    }
  
    // Quand on clique dans le champ, affiche la liste compl√®te
    buffSearch.addEventListener("focus", () => {
      updateBuffList(""); // montre tout
    });
  
    // Filtrage dynamique lors de la saisie
    buffSearch.addEventListener("input", e => {
      updateBuffList(e.target.value);
    });
  
    // Gestion du clic sur un buff
    buffDropdown.addEventListener("click", e => {
      const option = e.target.closest(".buff-option");
      if (!option) return;
      const buffId = parseInt(option.dataset.id);
      const buff = data.buffs.find(b => b.id === buffId);
      buffDropdown.style.display = "none";
      buffSearch.value = buff.name; // affiche le buff choisi
    });
  
    // Ferme la liste quand on clique ailleurs
    document.addEventListener("click", e => {
      if (!document.getElementById("buffSelector").contains(e.target)) {
        buffDropdown.style.display = "none";
      }
    }, true); // useCapture pour √™tre s√ªr qu‚Äôil s‚Äôex√©cute avant d‚Äôautres handlers

  const combatList=document.getElementById("combatList"); combatList.innerHTML="";
  data.combat.participants.forEach((p,i)=>{
    const div=document.createElement("div"); div.className="participant"+(i===data.combat.currentIndex?" active":"");
    
    let nameColor = "#fff";
    if(p.team==="h√©ros") nameColor="limegreen";
    else if(p.team==="alli√©") nameColor="orange";
    else if(p.team==="ennemi") nameColor="red";

    // Calculs pour la barre
    const hp = Math.max(0, p.hp);
    const sp = Math.max(0, p.sp || 0);
    
    const maxHp = Math.max(hp + sp, p.maxHp || 1);
    const hpRatio = Math.min(1, hp / maxHp);
    const spRatio = Math.min(1, sp / maxHp);
    
    div.innerHTML=`
<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
  <span style="color:${nameColor};"><b>${p.name}</b></span>
  <span class="clickable" onclick="openInitModal(${p.id})">üé≤ ${p.initiative}</span>
  <button class="small" onclick="moveUp(${i})">‚Üë</button>
  <button class="small" onclick="moveDown(${i})">‚Üì</button>
</div>

${(p.team === "h√©ros" || p.team === "alli√©") ? `
    <div class="hp-bar-container">
      <div class="hp-bar" style="width: ${hpRatio * 100}%"></div>
      ${sp > 0 ? `<div class="sp-bar" style="left:${hpRatio * 100}%; width:${spRatio * 100}%;"></div>` : ""}
      ${p.sp > 0 ? `
        <div class="hp-text clickable" onclick="openHpModal(${p.id})">${p.hp} ‚ù§Ô∏è ‚Äî ${p.sp} üõ°Ô∏è</div>
      ` : `
        <div class="hp-text clickable" onclick="openHpModal(${p.id})"> ${p.hp} ‚ù§Ô∏è</div>`
       }
    </div>
  ` : `
    <div class="pv-display clickable" onclick="openHpModal(${p.id})">
      ${p.hp} ü©∏
    </div>
  `
}

<div>
${p.activeBuffs.map((b,idx)=>`${b.name} (${b.duration}) <button class="small" onclick="removeBuff(${p.id},${idx})">‚ùå</button>`).join(", ") || "‚Äî"}
</div>
<button class="remove" onclick="removeParticipant(${p.id})">‚ùå</button>`;
    combatList.appendChild(div);
  });
  document.getElementById("roundDisplay").textContent=data.combat.round;
  if (data.combat.round === 0) document.getElementById("secondDisplay").textContent="Pr√©paration";
  else document.getElementById("secondDisplay").textContent=data.combat.round * 6;
  
  const secondDisplay = document.getElementById("secondDisplay");
  const secondLabel = document.getElementById("secondLabel");
  if (secondDisplay && secondLabel) {
    if (secondDisplay.textContent === "Pr√©paration") {
      secondLabel.style.display = "none"; // cache le mot "secondes"
    } else {
      secondLabel.style.display = "inline"; // l‚Äôaffiche sinon
    }
  }
  const nextTurn = document.getElementById("nextTurn");
  if (nextTurn) {
    nextTurn.disabled = !data.combat.started;
  }
}

function applyBuffToSelected(buff) {
  if (!buff) return;

  const allCheckboxes = document.querySelectorAll("#targetList input[type=checkbox]");
  const checkedBoxes = Array.from(allCheckboxes).filter(cb => cb.checked);
  const targetList = document.getElementById("targetList");

  // üõë Si aucune cible s√©lectionn√©e ‚Üí ouvrir le menu et ne rien effacer
  if (checkedBoxes.length === 0) {
    targetList.style.display = "block";
    return;
  }

  const casterId = data.combat.participants[data.combat.currentIndex]?.id || null;

  // ‚úÖ Appliquer le buff aux cibles s√©lectionn√©es
  checkedBoxes.forEach(cb => {
    const p = data.combat.participants.find(x => x.id === parseInt(cb.value));
    if (p) {
      p.activeBuffs.push({
        name: buff.name,
        value: buff.value,
        duration: buff.defaultDuration,
        casterId: casterId || null
      });
    }
  });

  // üßπ D√©coche toutes les cases apr√®s application
  allCheckboxes.forEach(cb => cb.checked = false);

  // ü™ü Ferme le menu des cibles
  targetList.style.display = "none";

  // üíæ Sauvegarde et rafra√Æchit
  saveData();
  renderCombat();

  // üßπ Efface le champ de recherche apr√®s application r√©ussie
  const buffSearch = document.getElementById("buffSearch");
  if (buffSearch) buffSearch.value = "";
}

// Modal de confirmation
function showConfirm(message, onYes, yesText = "Oui", noText = "Non") {
  const modal = document.getElementById("confirmModal");
  const confirmText = document.getElementById("confirmText");
  const yesBtn = document.getElementById("confirmYes");
  const noBtn = document.getElementById("confirmNo");

  confirmText.innerHTML = message.replace(/\n/g, "<br>");
  yesBtn.textContent = yesText;
  noBtn.textContent = noText;

  // üí° Si on veut une alerte simple (un seul bouton)
  if (!noText) {
    noBtn.style.display = "none";
  } else {
    noBtn.style.display = "inline-block";
  }

  modal.style.display = "flex";

  yesBtn.onclick = () => {
    modal.style.display = "none";
    if (onYes) onYes();
  };

  noBtn.onclick = () => {
    modal.style.display = "none";
  };
}

// D√©but combat
function startCombat() {
  // üß≠ V√©rifie s‚Äôil y a des participants
    if (!data.combat.participants || data.combat.participants.length === 0) {
          // Utilise showConfirm comme une alerte √† un seul bouton
          showConfirm("Le combat ne peut pas d√©marrer !\n\nAucun participant n‚Äôa √©t√© ajout√© au combat.", null, "Ok", null);
          return;
    }

  // üó°Ô∏è Sinon, demande de confirmation avant de d√©marrer
  showConfirm("Voulez-vous d√©marrer un nouveau combat ?", () => {
    data.combat.started = true;

    // Tri des participants par initiative d√©croissante
    data.combat.participants.sort((a, b) => b.initiative - a.initiative);

    // R√©initialisation des compteurs
    data.combat.round = 1;
    data.combat.currentIndex = 0;

    // Sauvegarde et affichage
    saveData();
    renderCombat();
    scrollToActive();

    // Active le bouton "Tour suivant"
    document.getElementById("nextTurn").disabled = false;
  });
}

// R√©initialisation combat
function resetCombat() {
  showConfirm("Voulez-vous r√©initialiser le combat ?", () => {
    data.combat.started = false;
    data.combat={participants:[],round:0,currentIndex:-1};
    saveData();renderCombat();renderCharSelect();
    document.getElementById("nextTurn").disabled = true; // d√©sactive √† nouveau
  });
}

let currentHpParticipant = null;
let modalHpTemp = 0; // pour tracer les modifs temporaires
let modalSpTemp = 0; // pour tracer les modifs temporaires

function openHpModal(id) {
  const p = data.combat.participants.find(x => x.id === id);
  if (!p) return;

  currentHpParticipant = p;
  modalHpTemp = 0; // reset variation
  modalSpTemp = 0; // reset variation

  // Remplir les infos du modal
  document.getElementById("hpModalName").textContent = p.name;
  updateHpModalDisplay();

  // Afficher le modal
  document.getElementById("hpModal").style.display = "flex";
}

function updateHpModalDisplay() {
  const displayHp = document.getElementById("hpModalDisplay");
  const displaySp = document.getElementById("spModalDisplay");
  const p = currentHpParticipant;
  if (!p) return;
  if (p.team === "ennemi") {
        document.getElementById("spModal").style.display="none";
  }
  
  if (modalHpTemp === 0) {
      displayHp.textContent = p.team === "ennemi" 
          ? `${p.hp} ü©∏`
          : `${p.hp}/${p.maxHp} ‚ù§Ô∏è`;
    } else {
      const sign = modalHpTemp > 0 ? "+" : "";
      displayHp.textContent = p.team === "ennemi" 
          ? `${p.hp + modalHpTemp} ü©∏ (${sign}${modalHpTemp})`
          : `${p.hp + modalHpTemp}/${p.maxHp} ‚ù§Ô∏è (${sign}${modalHpTemp})`;
    }
  if (modalSpTemp === 0) {
      displaySp.textContent = `${p.sp} üõ°`;
  } else {
      const sign = modalSpTemp > 0 ? "+" : "";
      displaySp.textContent = `${p.sp + modalSpTemp} üõ° (${sign}${modalSpTemp})`;
  }
}

function changeModalHp(delta) {
  if (!currentHpParticipant) return;

  const p = currentHpParticipant;
  if (p.team === "ennemi") {
      modalHpTemp = Math.max(- p.hp, modalHpTemp + delta);
  } else {
      modalHpTemp = Math.max(-10 - p.hp, Math.min(p.maxHp - p.hp, modalHpTemp + delta));
  }
  updateHpModalDisplay();
}

function changeModalSp(delta) {
  if (!currentHpParticipant) return;

  const p = currentHpParticipant;
  modalSpTemp = Math.max(- p.sp, modalSpTemp + delta);

  updateHpModalDisplay();
}

// Demande de confirmation avant de r√©initialiser les HP
function confirmResetHp() {
  showConfirm(
    "√ätes-vous s√ªr de vouloir r√©initialiser les PV/PV temporaires ?",
    () => {
      if (currentHpParticipant) {
        currentHpParticipant.hp = currentHpParticipant.maxHp || 0;
        currentHpParticipant.sp = 0;
        modalHpTemp = 0;
        modalSpTemp = 0;
        validateHpModal();
      }
    },
    "Oui",
    "Non"
  );
}

// Annuler la modification
function cancelHpModal() {
  document.getElementById("hpModal").style.display = "none";
  document.getElementById("spModal").style.display="flex";
  currentHpParticipant = null;
  modalHpTemp = 0;
  modalSpTemp = 0;
}

function validateHpModal() {
  if (currentHpParticipant && modalHpTemp !== 0) {
    currentHpParticipant.hp += modalHpTemp;
  }
  if (currentHpParticipant && modalSpTemp !== 0) {
    currentHpParticipant.sp += modalSpTemp
  }
  saveData();
  renderCombat();
  currentHpParticipant = null;
  modalHpTemp = 0;
  modalSpTemp = 0;
  
  document.getElementById("hpModal").style.display = "none";
  document.getElementById("spModal").style.display="flex";
}

let currentInitParticipant = null;
let modalInitTemp = 0;

// Ouvrir le modal d‚Äôinitiative
function openInitModal(id) {
  const p = data.combat.participants.find(x => x.id === id);
  if (!p) return;
  
  currentInitParticipant = p;
  modalInitTemp = 0; // reset variation
  
  document.getElementById("initModalName").textContent = p.name;
  updateInitModalDisplay();

  document.getElementById("initModal").style.display = "flex";
}

function updateInitModalDisplay() {
    displayInit = document.getElementById("initModalDisplay")
    const p = currentInitParticipant;
    if (!p) return;
    
    if (modalInitTemp === 0) {
        displayInit.textContent = `${p.initiative} üé≤`;
    } else {
        const sign = modalInitTemp > 0 ? "+" : "";
        displayInit.textContent = `${p.initiative + modalInitTemp} üé≤ (${sign}${modalInitTemp})`;
    }
}

// Changer la valeur d‚Äôinitiative
function changeModalInit(delta) {
    if (!currentInitParticipant) return;
    
    const p = currentInitParticipant;
    modalInitTemp += delta;
    
    updateInitModalDisplay();
}

// Demande de confirmation avant de r√©initialiser l'Initiative
function confirmResetInit() {
  showConfirm(
    "√ätes-vous s√ªr de vouloir r√©initialiser l'initiative a sa valeur de base ?",
    () => {
      if (currentInitParticipant) {
        currentInitParticipant.initiative = currentInitParticipant.baseInit;
        modalInitTemp = 0;
        validateInitModal();
      }
    },
    "Oui",
    "Non"
  );
}

// Fermer le modal
function cancelInitModal() {
  document.getElementById("initModal").style.display = "none";
  currentInitParticipant = null;
  modalInitTemp = 0;
}

function validateInitModal() {
  document.getElementById("initModal").style.display = "none";
  if (currentInitParticipant && modalInitTemp !== 0) {
      currentInitParticipant.initiative += modalInitTemp;
    }
    saveData();
    renderCombat();
    currentInitParticipant = null;
    modalInitTemp = 0;
}

// Ouvre le menu d‚Äôoptions
document.getElementById("settingsIcon").onclick = () => {
  document.getElementById("settingsModal").style.display = "flex";
};

// Ferme le menu d‚Äôoptions
function closeSettingsModal() {
  document.getElementById("settingsModal").style.display = "none";
}

function clearLocalStorage() {
    showConfirm("Voulez-vous vraiment effacer toutes les donn√©es de l'application ?\n\nCela supprimera d√©finitivement tous les personnages, buffs et combats.", () => {
    closeSettingsModal();
    localStorage.clear();
    location.reload(); // recharge l'application dans son √©tat initial
  });
}

// Initial render
function renderAll() {
    renderHeros();
    renderAllies();
    renderEnemies();
    renderBuffs();
    renderCharSelect();
    renderCombat();
}
renderAll();
</script>
<script>
  // Bloque le clic droit et le menu contextuel
  document.addEventListener('contextmenu', event => event.preventDefault());
</script>
<!-- Modal gestion PV -->
<div id="hpModal" class="modal">
  <div class="modal-content">
    <button id="resetHpBtn" class="reset-btn" onclick="confirmResetHp()">üîÑ </button>
    <h3 id="hpModalName"></h3>
    <div id="spModal" class="pv-control" style="margin-top: 16px;">
      <button class="small" onclick="changeModalSp(-10)">-10</button>
      <button class="small" onclick="changeModalSp(-1)">-1</button>
      <div id="spModalDisplay" class="pv-display"></div>
      <button class="small" onclick="changeModalSp(1)">+1</button>
      <button class="small" onclick="changeModalSp(10)">+10</button>
    </div>
    <div class="pv-control">
      <button class="small" onclick="changeModalHp(-10)">-10</button>
      <button class="small" onclick="changeModalHp(-1)">-1</button>
      <div id="hpModalDisplay" class="pv-display"></div>
      <button class="small" onclick="changeModalHp(1)">+1</button>
      <button class="small" onclick="changeModalHp(10)">+10</button>
    </div>
    <div class="modal-buttons">
          <button class="cancel" onclick="cancelHpModal()">Annuler</button>
          <button class="validate" onclick="validateHpModal()">Valider</button>
    </div>
  </div>
</div>

<!-- Modal gestion Initiative -->
<div id="initModal" class="modal">
  <div class="modal-content">
    <button id="resetInitBtn" class="reset-btn" onclick="confirmResetInit()">üîÑ </button>
    <h3 id="initModalName"></h3>
    <div class="init-control">
      <button class="small" onclick="changeModalInit(-5)">-5</button>
      <button class="small" onclick="changeModalInit(-1)">-1</button>
      <div id="initModalDisplay" class="init-display"></div>
      <button class="small" onclick="changeModalInit(1)">+1</button>
      <button class="small" onclick="changeModalInit(5)">+5</button>
    </div>
    <div class="modal-buttons">
      <button class="cancel" onclick="cancelInitModal()">Annuler</button>
      <button class="validate" onclick="validateInitModal()">Valider</button>
    </div>
  </div>
</div>
</body>
</html>
